<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Folk Songs Playlist</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div id="player">
    <ul id="playlist"></ul>
    <audio id="audioPlayer" controls></audio>
    <button id="clearButton">Clear</button>
    <button id="shareButton">Share</button>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const playlist = document.getElementById('playlist');
      const audioPlayer = document.getElementById('audioPlayer');
      const clearButton = document.getElementById('clearButton');
      const shareButton = document.getElementById('shareButton');
      let currentSongIndex = 0;

      function playSong(index) {
        const li = playlist.children[index];
        if (!li) return;
        audioPlayer.src = li.getAttribute('data-src');
        audioPlayer.play();
      }

      function initializePlaylistFromLocalStorage() {
        const saved = localStorage.getItem('playlist');
        if (!saved) return false;

        try {
          const songs = JSON.parse(saved);
          if (!Array.isArray(songs)) return false;

          playlist.innerHTML = '';
          songs.forEach(song => {
            const li = document.createElement('li');
            li.textContent = song.title || song.src;
            li.setAttribute('data-src', song.src);
            li.setAttribute('title', song.comments || '');
            playlist.appendChild(li);
          });

          return true;
        } catch (e) {
          console.error('Error parsing playlist from localStorage:', e);
          return false;
        }
      }

      function initializePlaylistFromURL() {
        const params = new URLSearchParams(window.location.search);
        const songsParam = params.get('songs');
        if (!songsParam) return false;

        const songs = songsParam.split(';').map(decodeURIComponent);
        playlist.innerHTML = '';

        songs.forEach(src => {
          const li = document.createElement('li');
          li.textContent = src.split('/').pop();
          li.setAttribute('data-src', src);
          playlist.appendChild(li);
        });

        return true;
      }

      function initializePlaylist() {
        const fromURL = initializePlaylistFromURL();
        if (!fromURL) {
          initializePlaylistFromLocalStorage();
        }
      }

      playlist.addEventListener('click', function (e) {
        if (e.target && e.target.tagName === 'LI') {
          const index = Array.from(playlist.children).indexOf(e.target);
          currentSongIndex = index;
          playSong(currentSongIndex);
        }
      });

      audioPlayer.addEventListener('ended', function () {
        currentSongIndex++;
        if (currentSongIndex < playlist.children.length) {
          playSong(currentSongIndex);
        }
      });

      function clearPlaylist() {
        localStorage.removeItem('playlist');
        playlist.innerHTML = '';
        audioPlayer.pause();
        audioPlayer.currentTime = 0;
        currentSongIndex = 0;
      }

      clearButton.addEventListener('click', clearPlaylist);

      shareButton.addEventListener('click', function () {
        const songPaths = Array.from(playlist.children).map(li => encodeURIComponent(li.getAttribute('data-src')));
        const playlistParam = songPaths.join(';');
        const shareURL = `${window.location.origin}${window.location.pathname}?songs=${playlistParam}`;
        const subject = encodeURIComponent('Check out this playlist');
        const body = encodeURIComponent(`Here is a playlist I thought you might like: ${shareURL}`);
        window.location.href = `mailto:?subject=${subject}&body=${body}`;
      });

      initializePlaylist();
    });
  </script>
</body>
</html>
