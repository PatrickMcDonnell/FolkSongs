<script>
    document.addEventListener('DOMContentLoaded', function() {
        const audioPlayer = document.getElementById('audio-player');
        const playlist = document.getElementById('playlist');
        const clearButton = document.getElementById('clear-playlist');
        const shareButton = document.getElementById('share-playlist');
        const baseUrl = 'https://patrickmcdonnell.github.io/FolkSongs/';
        let currentSongIndex = 0;

        function initializePlaylist() {
            playlist.innerHTML = '';
            const storedPlaylist = JSON.parse(localStorage.getItem('playlist'));

            if (storedPlaylist) {
                storedPlaylist.forEach((song) => {
                    const li = document.createElement('li');
                    li.textContent = song.title;
                    li.setAttribute('data-src', song.src);
                    li.setAttribute('data-comments', song.comments || '');
                    li.classList.add('song-item');

                    const hoverBox = document.createElement('div');
                    hoverBox.classList.add('hover-box');
                    hoverBox.textContent = song.comments || '';
                    li.appendChild(hoverBox);

                    playlist.appendChild(li);
                });

                if (storedPlaylist.length > 0) {
                    const firstSong = playlist.children[0];
                    audioPlayer.src = firstSong.getAttribute('data-src');
                    audioPlayer.play();
                }
            }
        }

        function clearPlaylist() {
            localStorage.removeItem('playlist');
            playlist.innerHTML = '';
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            currentSongIndex = 0;
        }

        function sharePlaylist() {
            const songs = playlist.querySelectorAll('li');
            if (songs.length === 0) {
                alert('The playlist is empty.');
                return;
            }

            let songList = '';
            songs.forEach(song => {
                const title = song.firstChild.nodeValue.trim();
                const relativePath = song.getAttribute('data-src');
                const fullUrl = baseUrl + relativePath.split('/').map(encodeURIComponent).join('/');
                const comments = song.getAttribute('data-comments').trim();

                if (comments) {
                    songList += `${title}: ${comments}\n${fullUrl}\n\n`;
                } else {
                    songList += `${title}\n${fullUrl}\n\n`;
                }
            });

            const subject = encodeURIComponent("Playlist from Pat's Music");
            const body = encodeURIComponent(
                songList + 
                '\n\nYou can see other songs here: https://patrickmcdonnell.github.io/FolkSongs/homepage.html\n\n'
            );
            const mailtoLink = `mailto:?subject=${subject}&body=${body}`;

            window.location.href = mailtoLink;
        }

        playlist.addEventListener('click', function(event) {
            if (event.target && event.target.matches('li.song-item')) {
                const songSrc = event.target.getAttribute('data-src');
                audioPlayer.src = songSrc;
                audioPlayer.play();
                currentSongIndex = Array.from(playlist.children).indexOf(event.target);
            }
        });

        audioPlayer.addEventListener('ended', function() {
            currentSongIndex++;
            if (currentSongIndex < playlist.children.length) {
                const nextSong = playlist.children[currentSongIndex];
                const nextSongSrc = nextSong.getAttribute('data-src');
                audioPlayer.src = nextSongSrc;
                audioPlayer.play();
            } else {
                currentSongIndex = 0;
            }
        });

        // Ensure the buttons work
        clearButton.addEventListener('click', clearPlaylist);
        shareButton.addEventListener('click', sharePlaylist);

        initializePlaylist();
    });
</script>
